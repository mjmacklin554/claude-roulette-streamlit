<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #ffffff; }
body .c { color: #888 } /* Comment */
body .err { color: #F00; background-color: #FAA } /* Error */
body .k { color: #080; font-weight: bold } /* Keyword */
body .o { color: #333 } /* Operator */
body .ch { color: #888 } /* Comment.Hashbang */
body .cm { color: #888 } /* Comment.Multiline */
body .cp { color: #579 } /* Comment.Preproc */
body .cpf { color: #888 } /* Comment.PreprocFile */
body .c1 { color: #888 } /* Comment.Single */
body .cs { color: #C00; font-weight: bold } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #F00 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888 } /* Generic.Output */
body .gp { color: #C65D09; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #04D } /* Generic.Traceback */
body .kc { color: #080; font-weight: bold } /* Keyword.Constant */
body .kd { color: #080; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #080; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #038; font-weight: bold } /* Keyword.Pseudo */
body .kr { color: #080; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #339; font-weight: bold } /* Keyword.Type */
body .m { color: #60E; font-weight: bold } /* Literal.Number */
body .s { background-color: #FFF0F0 } /* Literal.String */
body .na { color: #00C } /* Name.Attribute */
body .nb { color: #007020 } /* Name.Builtin */
body .nc { color: #B06; font-weight: bold } /* Name.Class */
body .no { color: #036; font-weight: bold } /* Name.Constant */
body .nd { color: #555; font-weight: bold } /* Name.Decorator */
body .ni { color: #800; font-weight: bold } /* Name.Entity */
body .ne { color: #F00; font-weight: bold } /* Name.Exception */
body .nf { color: #06B; font-weight: bold } /* Name.Function */
body .nl { color: #970; font-weight: bold } /* Name.Label */
body .nn { color: #0E84B5; font-weight: bold } /* Name.Namespace */
body .nt { color: #070 } /* Name.Tag */
body .nv { color: #963 } /* Name.Variable */
body .ow { color: #000; font-weight: bold } /* Operator.Word */
body .w { color: #BBB } /* Text.Whitespace */
body .mb { color: #60E; font-weight: bold } /* Literal.Number.Bin */
body .mf { color: #60E; font-weight: bold } /* Literal.Number.Float */
body .mh { color: #058; font-weight: bold } /* Literal.Number.Hex */
body .mi { color: #00D; font-weight: bold } /* Literal.Number.Integer */
body .mo { color: #40E; font-weight: bold } /* Literal.Number.Oct */
body .sa { background-color: #FFF0F0 } /* Literal.String.Affix */
body .sb { background-color: #FFF0F0 } /* Literal.String.Backtick */
body .sc { color: #04D } /* Literal.String.Char */
body .dl { background-color: #FFF0F0 } /* Literal.String.Delimiter */
body .sd { color: #D42 } /* Literal.String.Doc */
body .s2 { background-color: #FFF0F0 } /* Literal.String.Double */
body .se { color: #666; font-weight: bold; background-color: #FFF0F0 } /* Literal.String.Escape */
body .sh { background-color: #FFF0F0 } /* Literal.String.Heredoc */
body .si { background-color: #EEE } /* Literal.String.Interpol */
body .sx { color: #D20; background-color: #FFF0F0 } /* Literal.String.Other */
body .sr { color: #000; background-color: #FFF0FF } /* Literal.String.Regex */
body .s1 { background-color: #FFF0F0 } /* Literal.String.Single */
body .ss { color: #A60 } /* Literal.String.Symbol */
body .bp { color: #007020 } /* Name.Builtin.Pseudo */
body .fm { color: #06B; font-weight: bold } /* Name.Function.Magic */
body .vc { color: #369 } /* Name.Variable.Class */
body .vg { color: #D70; font-weight: bold } /* Name.Variable.Global */
body .vi { color: #33B } /* Name.Variable.Instance */
body .vm { color: #963 } /* Name.Variable.Magic */
body .il { color: #00D; font-weight: bold } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># From mb_roulette_v1.txt - Technical Requirements</span>
<span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span>
<span class="mi">32</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># A1 consisting of 16 numbers (4 x Corner Bets)</span>
<span class="n">A1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>

<span class="c1"># A2 consisting of 30 numbers (5 x Six-Line Bets): 1-6, 13-18, 19-24, 25-30, 31-36</span>
<span class="n">A2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">31</span><span class="p">]:</span>
    <span class="n">A2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Streamlit user inputs</span>
<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Michael&#39;s Roulette System Configuration&quot;</span><span class="p">)</span>

<span class="c1"># File input for outcomes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">numbers_folder</span> <span class="o">=</span> <span class="s2">&quot;numbers&quot;</span>
<span class="n">available_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">numbers_folder</span><span class="p">):</span>
    <span class="n">available_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">numbers_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.xls&#39;</span><span class="p">,</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">))]</span>

<span class="n">use_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span><span class="s2">&quot;Load outcomes from file&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">selected_file</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">use_file</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">available_files</span><span class="p">:</span>
        <span class="n">selected_file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Select file:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">available_files</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose an Excel (.xls/.xlsx) or CSV file from the numbers folder&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No Excel or CSV files found in the &#39;numbers&#39; folder&quot;</span><span class="p">)</span>
        <span class="n">use_file</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Starting sequence codes selection</span>
<span class="n">sequence_code_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Standard (3, 4, 2)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="s2">&quot;Alternative (8, 44, 10)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">selected_sequence_option</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Starting Sequence Codes:&quot;</span><span class="p">,</span>
                                       <span class="nb">list</span><span class="p">(</span><span class="n">sequence_code_options</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Choose the initial sequence codes (a, b, c) for the system&quot;</span><span class="p">)</span>

<span class="n">stage2_divisor</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Stage 2 Starting Divisor&quot;</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial divisor for Stage 2 betting calculations (default: 8)&quot;</span><span class="p">)</span>

<span class="c1"># Add a run button</span>
<span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run Simulation&quot;</span><span class="p">):</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Michael&#39;s Roulette Results&quot;</span><span class="p">)</span>

    <span class="c1"># Load outcomes from file or use default</span>
    <span class="k">if</span> <span class="n">use_file</span> <span class="ow">and</span> <span class="n">selected_file</span> <span class="ow">and</span> <span class="n">selected_file</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">numbers_folder</span><span class="p">,</span> <span class="n">selected_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selected_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
                <span class="c1"># Load CSV file with no header</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load Excel file (.xls or .xlsx) with no header</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Since we&#39;re loading with no header, use the first column which contains all the data</span>
            <span class="n">file_outcomes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">outcomes</span> <span class="o">=</span> <span class="n">file_outcomes</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span><span class="si">}</span><span class="s2"> outcomes from </span><span class="si">{</span><span class="n">selected_file</span><span class="si">}</span><span class="s2"> (first outcome: </span><span class="si">{</span><span class="n">outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading file </span><span class="si">{</span><span class="n">selected_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default outcomes instead&quot;</span><span class="p">)</span>
            <span class="c1"># Keep the original default outcomes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default test outcomes&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Fresh Roulette System&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A1 (16 Corner Bets): </span><span class="si">{</span><span class="n">A1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A2 (30 Six-Line Bets): </span><span class="si">{</span><span class="n">A2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Outcomes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Initialize variables - must be declared before functions that use nonlocal</span>
    <span class="n">initial_sequence_codes</span> <span class="o">=</span> <span class="n">sequence_code_options</span><span class="p">[</span><span class="n">selected_sequence_option</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sequence_code</span> <span class="o">=</span> <span class="n">initial_sequence_codes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">recording</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">current_bet_type</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1=Bet1, 2=Bet2, 3=Bet3</span>

    <span class="c1"># Session and sequence tracking</span>
    <span class="n">session_active</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sequence_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_bet_placed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Track if we&#39;ve placed the first bet in current sequence</span>

    <span class="c1"># Stage tracking</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1=Stage1, 2=Stage2</span>
    <span class="n">stage1_complete</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">stage2_recovery_target</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Will be set when Stage 1 ends</span>

    <span class="c1"># Stage 2 variables - will be set by user input</span>
    <span class="n">stage2_betting_active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Mixed numbers tracking</span>
    <span class="n">cumulative_negative</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">cumulative_positive_chips</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Track positive column in chips</span>

    <span class="c1"># A1 wait rule variables (Stage 1 only)</span>
    <span class="n">waiting_for_a1_losses</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Four corner loss rule variables</span>
    <span class="n">four_corner_rule_active</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">consecutive_non_a1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pending_sequence_codes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create DataFrame and collect debug messages - must be before functions</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">debug_messages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">balance_history</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track balance at each spin</span>

    <span class="c1"># Bank limits</span>
    <span class="n">starting_bank</span> <span class="o">=</span> <span class="mi">250</span>  <span class="c1"># units</span>
    <span class="n">current_bank_units</span> <span class="o">=</span> <span class="n">starting_bank</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_new_a</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate new &#39;a&#39; value for wins - from mb_roulette_v1.txt&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="mi">7</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">chips_to_mixed_number</span><span class="p">(</span><span class="n">chips</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert chip loss to mixed number format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">chips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c1"># For losses, chips will be negative</span>
        <span class="n">abs_chips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chips</span><span class="p">)</span>
        <span class="n">units_of_4</span> <span class="o">=</span> <span class="n">abs_chips</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">abs_chips</span> <span class="o">%</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">chips</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># For negative chips, we need to handle the remainder correctly</span>
            <span class="k">if</span> <span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">units_of_4</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Adjust for proper mixed number representation</span>
                <span class="c1"># e.g., 5 chips = -2.3 where -2*4 + 3 = -8+3 = -5</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">units_of_4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">remainder</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="n">units_of_4</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="n">remainder</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_mixed_numbers</span><span class="p">(</span><span class="n">mixed1</span><span class="p">,</span> <span class="n">mixed2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two mixed numbers together&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mixed1</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mixed1</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mixed2</span>
        <span class="k">if</span> <span class="n">mixed2</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mixed2</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mixed1</span>

        <span class="c1"># Simply add the integer parts (the decimal part is handled separately)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="n">mixed1</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mixed2</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">],</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="n">mixed1</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_chips_to_mixed_positive</span><span class="p">(</span><span class="n">current_mixed_positive</span><span class="p">,</span> <span class="n">additional_chips</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add chips to existing mixed number in positive column, return new mixed number&quot;&quot;&quot;</span>
        <span class="c1"># Convert current mixed positive decimal to chips</span>
        <span class="n">current_chips</span> <span class="o">=</span> <span class="n">current_mixed_positive</span>

        <span class="c1"># Add the additional chips</span>
        <span class="n">total_chips</span> <span class="o">=</span> <span class="n">current_chips</span> <span class="o">+</span> <span class="n">additional_chips</span>

        <span class="c1"># Convert back to mixed number</span>
        <span class="k">return</span> <span class="n">chips_to_mixed_number</span><span class="p">(</span><span class="n">total_chips</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_recovery_profit</span><span class="p">(</span><span class="n">negative_mixed</span><span class="p">,</span> <span class="n">positive_mixed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate if loss is recovered and return profit in chips&quot;&quot;&quot;</span>
        <span class="c1"># Convert both to chips and add</span>
        <span class="n">negative_chips</span> <span class="o">=</span> <span class="n">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">negative_mixed</span><span class="p">)</span>
        <span class="n">positive_chips</span> <span class="o">=</span> <span class="n">positive_mixed</span>  <span class="c1"># This is already in chips from decimal part</span>

        <span class="n">total</span> <span class="o">=</span> <span class="n">negative_chips</span> <span class="o">+</span> <span class="n">positive_chips</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>  <span class="c1"># Return 0 if still negative, otherwise return profit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">mixed_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert mixed number dict back to chips&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mixed_dict</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># For negative mixed numbers, decimal is already accounted for in the conversion</span>
            <span class="k">return</span> <span class="n">mixed_dict</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">mixed_dict</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">mixed_dict</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mixed_to_chips</span><span class="p">(</span><span class="n">mixed_num</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert mixed number back to chips&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mixed_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">mixed_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Handle negative mixed numbers</span>
            <span class="n">str_mixed</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mixed_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">str_mixed</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">str_mixed</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Already negative</span>
                <span class="n">decimal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">units</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">decimal</span>  <span class="c1"># units*4 is negative, decimal positive</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">mixed_num</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle positive mixed numbers</span>
            <span class="n">str_mixed</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mixed_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">str_mixed</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">str_mixed</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">decimal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">units</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">decimal</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">mixed_num</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>

    <span class="c1"># Remove the nested functions and put logic inline in the main loop</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outcomes</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_active</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># Stop processing if session ended</span>
        <span class="n">line_num</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Determine win/loss (W if in A1, L otherwise)</span>
        <span class="n">win_status</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span> <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span> <span class="k">else</span> <span class="s1">&#39;L&#39;</span>

        <span class="c1"># Initialize row</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">line_num</span><span class="p">,</span>
            <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="n">outcome</span><span class="p">,</span>
            <span class="s1">&#39;win&#39;</span><span class="p">:</span> <span class="n">win_status</span><span class="p">,</span>
            <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actual bet&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;negative&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Check for first A1 win to start recording</span>
        <span class="k">if</span> <span class="n">win_status</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">recording</span> <span class="ow">and</span> <span class="n">session_active</span><span class="p">:</span>
            <span class="n">recording</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">sequence_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequence </span><span class="si">{</span><span class="n">sequence_number</span><span class="si">}</span><span class="s2"> started! First A1 win at line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2"> - sequence codes will start next line&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">balance_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>  <span class="c1"># Track balance</span>
            <span class="k">continue</span>

        <span class="c1"># If recording and session is active, process betting and sequence codes</span>
        <span class="k">if</span> <span class="n">recording</span> <span class="ow">and</span> <span class="n">session_active</span><span class="p">:</span>
            <span class="c1"># Check if we have pending sequence codes to apply (from four corner rule)</span>
            <span class="k">if</span> <span class="n">pending_sequence_codes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">four_corner_rule_active</span><span class="p">:</span>
                <span class="n">sequence_code</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pending_sequence_codes</span><span class="p">)</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying pending sequence codes: </span><span class="si">{</span><span class="n">pending_sequence_codes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">pending_sequence_codes</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Handle sequence code display with four corner rule</span>
            <span class="k">if</span> <span class="n">four_corner_rule_active</span><span class="p">:</span>
                <span class="c1"># Four corner rule active - don&#39;t show sequence codes on this line</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Four corner rule: suppressing sequence codes on line </span><span class="si">{</span><span class="n">line_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pending_sequence_codes</span><span class="p">:</span>
                <span class="c1"># Apply pending codes from four corner rule</span>
                <span class="n">sequence_code</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pending_sequence_codes</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying delayed four corner codes: </span><span class="si">{</span><span class="n">pending_sequence_codes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">pending_sequence_codes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Normal sequence code display</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>

            <span class="c1"># Place bet (stage-dependent logic)</span>
            <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Stage 1 betting logic (inline)</span>
                <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

                <span class="c1"># Check A1 wait rule first</span>
                <span class="k">if</span> <span class="n">waiting_for_a1_losses</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span><span class="p">:</span>
                        <span class="c1"># A1 outcome resets the counter</span>
                        <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Non-A1 outcome increments counter</span>
                        <span class="n">non_a1_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">non_a1_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">waiting_for_a1_losses</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A1 wait period ended after 3 non-A1 outcomes&quot;</span><span class="p">)</span>
                        <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Determine bet parameters based on current bet type</span>
                    <span class="k">if</span> <span class="n">current_bet_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">bet_amount</span> <span class="o">=</span> <span class="mi">5</span>
                        <span class="n">bet_numbers</span> <span class="o">=</span> <span class="n">A2</span>
                        <span class="n">win_profit</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">bet_units</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">current_bet_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">bet_amount</span> <span class="o">=</span> <span class="mi">4</span>
                        <span class="n">bet_numbers</span> <span class="o">=</span> <span class="n">A1</span>
                        <span class="n">win_profit</span> <span class="o">=</span> <span class="mi">5</span>
                        <span class="n">bet_units</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">current_bet_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">bet_amount</span> <span class="o">=</span> <span class="mi">8</span>
                        <span class="n">bet_numbers</span> <span class="o">=</span> <span class="n">A1</span>
                        <span class="n">win_profit</span> <span class="o">=</span> <span class="mi">10</span>
                        <span class="n">bet_units</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

                    <span class="k">if</span> <span class="n">current_bet_type</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># Check if it&#39;s a win</span>
                        <span class="n">is_win</span> <span class="o">=</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">bet_numbers</span>

                        <span class="k">if</span> <span class="n">is_win</span><span class="p">:</span>
                            <span class="c1"># Handle win logic</span>
                            <span class="k">if</span> <span class="n">current_bet_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">balance</span> <span class="o">+=</span> <span class="n">win_profit</span>
                                <span class="n">current_bet_type</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span><span class="p">:</span>
                                    <span class="n">waiting_for_a1_losses</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A1 win detected - starting wait for 3 consecutive non-A1 outcomes&quot;</span><span class="p">)</span>
                                <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="n">bet_amount</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Bet2 or Bet3 win on A1 - mixed number logic</span>
                                <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bet_units</span>
                                <span class="n">bip_chips</span> <span class="o">=</span> <span class="n">bet_units</span>
                                <span class="n">existing_decimal_chips</span> <span class="o">=</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span>
                                <span class="n">cumulative_positive_chips</span> <span class="o">=</span> <span class="n">existing_decimal_chips</span> <span class="o">+</span> <span class="n">bip_chips</span>
                                <span class="n">negative_chips</span> <span class="o">=</span> <span class="n">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">)</span>
                                <span class="n">total_recovery</span> <span class="o">=</span> <span class="n">negative_chips</span> <span class="o">+</span> <span class="n">cumulative_positive_chips</span>
                                <span class="k">if</span> <span class="n">total_recovery</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">balance</span> <span class="o">+=</span> <span class="n">total_recovery</span>
                                <span class="n">current_bet_type</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span><span class="p">:</span>
                                    <span class="n">waiting_for_a1_losses</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A1 win detected - starting wait for 3 consecutive non-A1 outcomes&quot;</span><span class="p">)</span>
                                <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="n">bet_amount</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Handle loss with mixed numbers</span>
                            <span class="n">loss_mixed_number</span> <span class="o">=</span> <span class="n">chips_to_mixed_number</span><span class="p">(</span><span class="o">-</span><span class="n">bet_amount</span><span class="p">)</span>
                            <span class="n">cumulative_negative</span> <span class="o">=</span> <span class="n">add_mixed_numbers</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">,</span> <span class="n">loss_mixed_number</span><span class="p">)</span>
                            <span class="n">current_bet_type</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">current_bet_type</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bet3 lost. Stage 1 ends, Stage 2 begins.&quot;</span><span class="p">)</span>
                                <span class="n">stage1_complete</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">stage</span> <span class="o">=</span> <span class="mi">2</span>
                                <span class="n">negative_chips</span> <span class="o">=</span> <span class="n">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">)</span>
                                <span class="n">stage2_recovery_target</span> <span class="o">=</span> <span class="n">negative_chips</span>
                                <span class="n">cumulative_positive_chips</span> <span class="o">=</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span>
                            <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="n">bet_amount</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="n">loss_mixed_number</span><span class="p">,</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># In Stage 2, check if sequence codes are being displayed</span>
                <span class="n">codes_displayed</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">four_corner_rule_active</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pending_sequence_codes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">four_corner_rule_active</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">four_corner_rule_active</span><span class="p">:</span>
                    <span class="n">codes_displayed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># If sequence codes are shown in this row</span>
                    <span class="n">codes_displayed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">codes_displayed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Stage 2 betting logic (inline)</span>
                <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">codes_displayed</span><span class="p">:</span>
                    <span class="c1"># Check if a &gt; 10 (no betting if true), UNLESS negative &gt; 20 units</span>
                    <span class="n">negative_units</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">negative_units</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">):</span>
                        <span class="c1"># Calculate bet units: c / divisor</span>
                        <span class="k">if</span> <span class="n">stage2_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">stage2_divisor</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: stage2_divisor was 0, reset to 1&quot;</span><span class="p">)</span>
                        <span class="n">normal_bet_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">stage2_divisor</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">normal_bet_units</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">normal_bet_units</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Minimum bet</span>

                        <span class="c1"># Risk management: Calculate minimum recovery bet for final bet</span>
                        <span class="c1"># Only considering integer/whole numbers for recovery calculation</span>
                        <span class="n">negative_integer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">])</span>
                        <span class="n">positive_integer</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">cumulative_positive_chips</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">positive_mixed</span> <span class="o">=</span> <span class="n">chips_to_mixed_number</span><span class="p">(</span><span class="n">cumulative_positive_chips</span><span class="p">)</span>
                            <span class="n">positive_integer</span> <span class="o">=</span> <span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span>

                        <span class="c1"># Recovery calculation: (negative + positive) * 0.8</span>
                        <span class="n">recovery_shortfall</span> <span class="o">=</span> <span class="n">negative_integer</span> <span class="o">-</span> <span class="n">positive_integer</span>
                        <span class="n">risk_managed_bet_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">recovery_shortfall</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">risk_managed_bet_units</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">risk_managed_bet_units</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Minimum bet</span>

                        <span class="c1"># Use the smaller of normal bet or risk-managed bet</span>
                        <span class="n">bet_units</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">normal_bet_units</span><span class="p">,</span> <span class="n">risk_managed_bet_units</span><span class="p">)</span>

                        <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 2 bet calculation: Normal=</span><span class="si">{</span><span class="n">normal_bet_units</span><span class="si">}</span><span class="s2">, Risk-managed=</span><span class="si">{</span><span class="n">risk_managed_bet_units</span><span class="si">}</span><span class="s2">, Using=</span><span class="si">{</span><span class="n">bet_units</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>
                        <span class="n">bet_chips</span> <span class="o">=</span> <span class="n">bet_units</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># Convert units to chips</span>

                        <span class="c1"># Check if it&#39;s a win (A1 numbers only in Stage 2)</span>
                        <span class="n">is_win</span> <span class="o">=</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span>

                        <span class="k">if</span> <span class="n">is_win</span><span class="p">:</span>
                            <span class="c1"># Stage 2 win - apply mixed number recovery logic</span>
                            <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bet_units</span>
                            <span class="n">bip_chips</span> <span class="o">=</span> <span class="n">bet_units</span>  <span class="c1"># 1 unit = 1 chip BIP</span>
                            <span class="n">cumulative_positive_chips</span> <span class="o">+=</span> <span class="n">bip_chips</span>

                            <span class="c1"># Check for complete recovery</span>
                            <span class="n">negative_chips</span> <span class="o">=</span> <span class="n">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">)</span>
                            <span class="n">total_recovery</span> <span class="o">=</span> <span class="n">negative_chips</span> <span class="o">+</span> <span class="n">cumulative_positive_chips</span>

                            <span class="k">if</span> <span class="n">total_recovery</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Full recovery achieved!</span>
                                <span class="n">balance</span> <span class="o">+=</span> <span class="n">total_recovery</span>
                                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage 2 recovery successful! Recovered 17 chips plus </span><span class="si">{</span><span class="n">total_recovery</span><span class="si">}</span><span class="s2"> profit.&quot;</span><span class="p">)</span>
                                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequence completed successfully.&quot;</span><span class="p">)</span>
                                <span class="n">stage</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Mark as completed</span>

                            <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="n">bet_chips</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">bet_units</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Stage 2 loss</span>
                            <span class="n">loss_mixed_number</span> <span class="o">=</span> <span class="n">chips_to_mixed_number</span><span class="p">(</span><span class="o">-</span><span class="n">bet_chips</span><span class="p">)</span>
                            <span class="n">cumulative_negative</span> <span class="o">=</span> <span class="n">add_mixed_numbers</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">,</span> <span class="n">loss_mixed_number</span><span class="p">)</span>

                            <span class="c1"># Check if bank is lost (1000 chips = 250 units)</span>
                            <span class="n">total_negative_chips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mixed_to_chips_from_dict</span><span class="p">(</span><span class="n">cumulative_negative</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">total_negative_chips</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
                                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bank lost! Stage 2 recovery failed.&quot;</span><span class="p">)</span>
                                <span class="n">stage</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Mark as failed</span>

                            <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="n">bet_chips</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">bet_units</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="n">loss_mixed_number</span><span class="p">,</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Stage completed, no more betting</span>
                <span class="n">bet_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;loss_mixed&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s1">&#39;win_mixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="c1"># Show STOP message on line after recovery</span>
                <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual bet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STOP&#39;</span>
                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovery in Stage 2 has now been successfully completed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Mark that first bet has been placed</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">first_bet_placed</span><span class="p">:</span>
                    <span class="n">first_bet_placed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Display bet type based on stage</span>
                <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Stage 1 bet display</span>
                    <span class="k">if</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual bet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bet 1&#39;</span>
                    <span class="k">elif</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual bet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bet 2&#39;</span>
                    <span class="k">elif</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;bet_amount&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual bet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bet 3&#39;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">bet_result</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">bet_result</span><span class="p">:</span>
                    <span class="c1"># Stage 2 bet display - show units (including recovery line)</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual bet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> units&quot;</span>

                <span class="c1"># Handle mixed numbers for losses</span>
                <span class="k">if</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;loss_mixed&#39;</span><span class="p">][</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;loss_mixed&#39;</span><span class="p">][</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Display cumulative negative mixed number</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span>

                    <span class="c1"># Show decimal part in positive column only if there&#39;s a remainder AND it&#39;s the first loss in sequence</span>
                    <span class="k">if</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="c1"># No balance shown for losses during Stage 1</span>
                <span class="k">elif</span> <span class="n">bet_result</span><span class="p">[</span><span class="s1">&#39;win_mixed&#39;</span><span class="p">]:</span>
                    <span class="c1"># Bet2 or Bet3 win with mixed number logic (Stage 1) or Stage 2 win</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_negative</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span>

                    <span class="c1"># Display positive column with mixed number format</span>
                    <span class="k">if</span> <span class="n">cumulative_positive_chips</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">positive_mixed</span> <span class="o">=</span> <span class="n">chips_to_mixed_number</span><span class="p">(</span><span class="n">cumulative_positive_chips</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;integer&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Show just integer, not .0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;positive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">positive_mixed</span><span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="c1"># Show balance only if recovery is complete (Stage 3) or normal Stage 1 win</span>
                    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance</span>

                    <span class="c1"># Reset mixed numbers after recovery (if stage is completed)</span>
                    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">cumulative_negative</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                        <span class="n">cumulative_positive_chips</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Normal win case (Bet1)</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance</span>

            <span class="c1"># Track consecutive non-A1 outcomes for four corner rule (always track)</span>
            <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span><span class="p">:</span>
                <span class="n">consecutive_non_a1</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset counter on A1 outcome</span>
                <span class="k">if</span> <span class="n">four_corner_rule_active</span><span class="p">:</span>
                    <span class="c1"># A1 outcome ends four corner rule</span>
                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Four corner loss rule ended - A1 outcome detected&quot;</span><span class="p">)</span>
                    <span class="n">four_corner_rule_active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consecutive_non_a1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Consecutive non-A1 count: </span><span class="si">{</span><span class="n">consecutive_non_a1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update sequence codes for next line (ALWAYS update, even during A1 wait)</span>
            <span class="n">is_a1_win</span> <span class="o">=</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">A1</span>

            <span class="c1"># Sequence code update logic (inline)</span>
            <span class="k">if</span> <span class="n">is_a1_win</span><span class="p">:</span>
                <span class="c1"># Win logic from mb_roulette_v1.txt</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_new_a</span><span class="p">(</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
                <span class="c1"># Prevent division by zero</span>
                <span class="k">if</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: sequence_code[&#39;a&#39;] was 0, reset to 1&quot;</span><span class="p">)</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Loss logic from mb_roulette_v1.txt</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>

                <span class="c1"># Special rule: If B &gt; 89 then B = (Int(B+1)) / 2</span>
                <span class="k">if</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">89</span><span class="p">:</span>
                    <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># In Stage 2, halve the divisor when b &gt; 89 rule applies AND we&#39;re actively betting</span>
                    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">stage2_divisor</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">recording</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">four_corner_rule_active</span><span class="p">:</span>
                        <span class="n">stage2_divisor</span> <span class="o">=</span> <span class="n">stage2_divisor</span> <span class="o">//</span> <span class="mi">2</span>
                        <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;b &gt; 89 rule applied in Stage 2 - divisor reduced to </span><span class="si">{</span><span class="n">stage2_divisor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Prevent division by zero</span>
                <span class="k">if</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: sequence_code[&#39;a&#39;] was 0, reset to 1&quot;</span><span class="p">)</span>
                <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">2</span>

            <span class="c1"># Check for sequence completion (a &lt; 3 after first bet)</span>
            <span class="k">if</span> <span class="n">first_bet_placed</span> <span class="ow">and</span> <span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequence </span><span class="si">{</span><span class="n">sequence_number</span><span class="si">}</span><span class="s2"> completed! (a=</span><span class="si">{</span><span class="n">sequence_code</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt; 3)&quot;</span><span class="p">)</span>
                <span class="c1"># Reset for new sequence</span>
                <span class="n">sequence_code</span> <span class="o">=</span> <span class="n">initial_sequence_codes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">recording</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Will restart on next A1 win</span>
                <span class="n">current_bet_type</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">stage</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">stage1_complete</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">waiting_for_a1_losses</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">non_a1_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">four_corner_rule_active</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">consecutive_non_a1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pending_sequence_codes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cumulative_negative</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">cumulative_positive_chips</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">first_bet_placed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Check bank status</span>
                <span class="n">current_bank_units</span> <span class="o">=</span> <span class="n">starting_bank</span> <span class="o">+</span> <span class="p">(</span><span class="n">balance</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Convert balance back to units</span>
                <span class="k">if</span> <span class="n">current_bank_units</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bank depleted! Session ends.&quot;</span><span class="p">)</span>
                    <span class="n">session_active</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Check if we just hit 4 consecutive non-A1 (triggers four corner rule)</span>
            <span class="k">if</span> <span class="n">consecutive_non_a1</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">four_corner_rule_active</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pending_sequence_codes</span> <span class="o">=</span> <span class="n">sequence_code</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">debug_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Four corner rule triggered! Calculated codes </span><span class="si">{</span><span class="n">pending_sequence_codes</span><span class="si">}</span><span class="s2"> will be delayed&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">balance_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>  <span class="c1"># Track balance after each spin</span>

    <span class="c1"># Create and display DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Create balance progression graph</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Balance Progression&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">balance_history</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">spins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">balance_history</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spins</span><span class="p">,</span> <span class="n">balance_history</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Spin Number&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Balance&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Balance vs Number of Spins&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Break-even line&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No balance data to display&quot;</span><span class="p">)</span>

    <span class="c1"># Display debug messages</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;System Messages&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug_messages</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">debug_messages</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No system messages generated&quot;</span><span class="p">)</span>

    <span class="c1"># Display final balance and session summary</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Final Results&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Session Summary:**&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Starting Sequence Codes: </span><span class="si">{</span><span class="n">selected_sequence_option</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total Sequences Completed: </span><span class="si">{</span><span class="n">sequence_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Final Balance: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2"> chips&quot;</span><span class="p">)</span>
    <span class="n">final_bank_units</span> <span class="o">=</span> <span class="n">starting_bank</span> <span class="o">+</span> <span class="p">(</span><span class="n">balance</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Final Bank: </span><span class="si">{</span><span class="n">final_bank_units</span><span class="si">}</span><span class="s2"> units (started with </span><span class="si">{</span><span class="n">starting_bank</span><span class="si">}</span><span class="s2"> units)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_active</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Session Status: **ENDED** (Bank depleted or sequence completion)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Session Status: **ACTIVE** (All outcomes processed)&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Outcomes Processed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Betting Results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final Balance: </span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</body>
</html>
